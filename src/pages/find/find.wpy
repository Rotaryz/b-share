<template>
  <view class="find">
    <cover-view class="nav" style="bottom:{{bottom}}">
      <cover-view wx:for="{{nav}}" wx:key="{{index}}"
                  class="item {{navIndex === index ? 'item-active' : ''}}"
                  @tap="checkNav({{index}})">
        {{item.title}}
        <cover-view class="item-line"></cover-view>
      </cover-view>
      <cover-view class="find-line"></cover-view>
    </cover-view>
    <!--<view class="loading {{isLoad ? 'load-active' : ''}}">-->
    <!--<image class="load-img" wx:if="{{imageUrl}}"-->
    <!--src="{{imageUrl + '/defaults/share/page/icon-loading@2x.png'}}"></image>-->
    <!--<view class="load-refresh">刷新中…</view>-->
    <!--</view>-->
    <Blank></Blank>
    <view class="list-box {{!isLoad ? 'find-box-active' : 'find-big-box'}}"
          @tap="goAnswer">
      <view class="find-item guidance" wx:if="{{!isChecked}}">
        <view class="find-box">
          <view class="cainter">
            <view class="user">
              <image class="header"></image>
              <text class="nickname">共享美导</text>
            </view>
            <view class="words">完成实名认证后，领取更多现金红包！</view>
            <image src="" class="img-one-item"></image>
          </view>
          <view class="information" @tap="delStick">
            删除
          </view>
        </view>
      </view>
      <view>
        <repeat wx:if="{{findList.length}}" for="{{findList}}" key="index"
                index="index" item="item">
          <FindDetail :find.sync="item" :listNum.sync="index"></FindDetail>
        </repeat>
      </view>
    </view>
    <UnderlineBlock></UnderlineBlock>
    <view class="compile-icon" @tap="goCompile">
      <image class="compile-pic" wx:if="{{imageUrl}}"
             src="{{imageUrl + '/defaults/share/page/icon-write@2x.png'}}"></image>
    </view>
    <Toast></Toast>
    <PopUpWindows></PopUpWindows>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import base from 'common/mixins/base'
  import URIS from 'common/js/config'
  import {ERR_OK} from 'api/base'
  import FindDetail from '@/base/find-detail/find-detail'
  import Toast from '@/base/toast/toast'
  import logs from 'api/logs'
  import PopUpWindows from '@/base/pop-up-windows/pop-up-windows'
  import UnderlineBlock from '@/base/underline-block/underline-block'
  import Blank from '@/base/blank/blank'

  const NAV = [{title: '我关注的', type: 1}, {title: '全部', type: 0}, {
    title: '美导',
    type: 2
  }, {title: '门店', type: 3}]
  export default class find extends wepy.page {
    mixins = [base]

    config = {
      navigationBarTitleText: '共享美导',
      onReachBottomDistance: 30,
      enablePullDownRefresh: true,
      backgroundTextStyle: 'dark'
    }
    data = {
      imageUrl: URIS.image,
      nav: NAV,
      navIndex: 0,
      isLoad: false,
      showGuidance: true,
      findList: [],
      page: 1,
      isChecked: true,
      scrollTop: '',
      startTop: 0,
      endTop: 0,
      isPull: false,
      option: 1,
      loadMore: true,
      content: '',
      delIndex: {},
      bottom: 0,
      check: false
    }

    async onPullDownRefresh() {
      this.findList = await this.load(this.option)
      setTimeout(() => {
        wepy.stopPullDownRefresh()
        this.bottom = 0
        this.$apply()
      }, 50)
      this.$apply()
    }

    async onLoad() {
      this.findList = await this.load()
      this.showBlank(this.findList)
      this.$apply()
    }

    async onShow() {
      if (this.$parent.globalData.status && this.$parent.globalData.status === 2) {
        this.$invoke('PopUpWindows', 'show', '内容不会保存，退出编辑？')
        this.content = true
      } else if (this.$parent.globalData.status && this.$parent.globalData.status === 1) {
//        刷新列表
        wepy.startPullDownRefresh()
        await this.onPullDownRefresh()
      }
      if (this.$parent.globalData.logId) {
        let id = this.$parent.globalData.logId
        for (let i = 0; i < this.findList.length; i++) {
          if (this.findList[i].id === id) {
            this.findList.splice(i, 1)
            this.$parent.updateGlobalData('logId', null)
            this.$apply()
            break
          }
        }
      }
      this.$apply()
//      wepy.connectSocket({
//        url: 'wss://192.168.4.98:3000'
//      })
//      wepy.onSocketOpen((res) => {
//        console.log('WebSocket连接已打开！')
//      })
    }

    showBlank(res) {
      if (res.length === 0 && this.isChecked) {
        this.$invoke('Blank',
          'show',
          this.imageUrl + '/defaults/share/page/pic-nothing@2x.png', '暂无内容', '35.2')
      } else {
        this.$invoke('Blank', 'hide')
      }
    }

    async onReachBottom() {
      this.bottom = 0
      this.page++
      if (this.loadMore) {
        let res = await this.load(this.option, this.page)
        this.loadMore = res.length !== 0
        this.findList = this.findList.concat(res)
        this.$apply()
      }
    }

    async load(option = 1, page = 1) {
      let data = {option: option, page: page}
      let findList = await logs.findList(data)
      let isChecked = wepy.getStorageSync('isChecked')
      if (!isChecked) {
        this.isChecked = findList.is_checked
      }
      let res = this.infoRes(findList)
      if (res && res.length !== 0) {
        res.map((item) => {
          if (item.user_live_log_details.length === 0 && item.content.length > 50) {
            item.content = item.content.slice(0, 50)
            item.showDetail = true
            return item
          }
        })
      }
      this.loaded()
      return res
    }

    infoRes(res) {
      if (res.error === ERR_OK) {
        return res.data
      }
    }

    methods = {
      goAnswer() {
        this.$navigate('/pages/answer-index/answer-index')
      },
      delStick() {
        this.check = true
        this.$invoke('PopUpWindows', 'show', '是否确定删除该系统信息？')
      },
      async checkNav(index) {
        this.navIndex = index * 1
        this.option = this.nav[this.navIndex].type
        this.findList = await this.load(this.option)
        this.loadMore = true
        this.showBlank(this.findList)
        this.$apply()
      },
      goCompile() {
        wepy.navigateTo({
          url: '/pages/compile/compile'
        })
      }
    }

    events = {
      good(res, index) {
        this.findList[index] = res
      },
      async delFind(id) {
        this.$invoke('PopUpWindows', 'show', '是否确定删除服务日志？')
        this.content = false
        this.check = false
        for (let i = 0; i < this.findList.length; i++) {
          if (this.findList[i].id === id) {
            Object.assign(this.delIndex, {id: id, index: i})
            break
          }
        }
      },
      async sure() {
        if (!this.content) {
          let res = await logs.delFind(this.delIndex.id)
          this.loaded()
          if (res.error === ERR_OK) {
            this.findList.splice(this.delIndex.index, 1)
            this.$apply()
          }
        } else if (this.check) {
          this.isChecked = true
          wepy.setStorageSync('isChecked', this.isChecked)
        }

        this.$parent.updateGlobalData('status', 1)
      },
      cancel() {
        if (this.content) {
          wepy.navigateTo({
            url: '/pages/compile/compile?status=1'
          })
          this.check = false
        }
      }
    }
    watch = {
      loadMore(newValue) {
        if (!newValue) {
          this.$invoke('UnderlineBlock', 'show')
        } else {
          this.$invoke('UnderlineBlock', 'hide')
        }
      }
    }

    components = {
      Toast: Toast,
      FindDetail: FindDetail,
      PopUpWindows: PopUpWindows,
      UnderlineBlock: UnderlineBlock,
      Blank: Blank
    }
  }
</script>

<style lang="stylus">
  @import '../../common/stylus/variable'
  @import '../../common/stylus/mixin'
  .find
    min-height: 100vh
    overflow-y: auto
    background: $color-white
    position: relative
    .loading
      position: fixed
      top: 45px
      width: 100%
      margin-top: 0px
      height: 30px
      background: $color-background
      display: flex
      justify-content: center
      align-items: center
      font-size: $font-size-small
      transition: height 1s
      .load-refresh
        color: $color-text-tr
        margin-left: 5px
      .load-img
        width: 17px
        height: @width
    .load-active
      margin-top: 45px
      height: 30px
      transition: height 1s

  /*animation :loadRotate 1s linear 2s infinite*/
  .list-box
    margin-bottom: 50px

  .guidance
    .img-one-item
      width: 100%
      height: 26.4vw
      background: $color-background
    .words
      white-space: nowrap
    .header
      background: $color-split-line
    .information
      display: block
      padding-left: 0px
      color: $color-del

  .find-big-box
    margin-top: 0px

  .find-box-active
    margin-top: 60px

  .nav
    background: $color-white
    height: 45px
    font-size: $font-size-medium-x
    display: flex
    justify-content: space-between
    padding: 0 15px
    box-sizing: border-box
    position: fixed
    top: 0px
    left: 0
    width: 100%
    z-index: 1000
    .find-line
      height: 0.5px
      background: $color-split-line
      width: 100%
      position: absolute
      bottom: 0
      left: 0
    .item
      color: $color-text-tr
      position: relative
      height: 100%
      line-height: 45px
      .item-line
        height: 3px
        width: 24px
        row-center()
        bottom: -1px
        z-index: 500
        background: transparent
    .item-active
      color: $color-text
      .item-line
        background: $color-assist-pink

  .compile-icon
    position: fixed
    bottom: 0px
    right: 0px
    .compile-pic
      width: 67px
      height: @width

  cover-view
    &:active
      background: $color-white
</style>
