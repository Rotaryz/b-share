<style lang="stylus">
  @import "./common/stylus/index"
</style>

<script>
  import wepy from 'wepy'
  import 'wepy-async-function'
  import URIS from 'common/js/config'
  import io from './socket/index'
  export default class extends wepy.app {
    constructor() {
      super()
      this.use('requestfix')
      this.use('promisify')
    }

    onLaunch(options) {
      console.log(io)
      const socket = io('wss://ws.jerryf.cn')

      this.updateGlobalData('socket', socket)
      // 校验SDK
//      wxUtils.checkSDK()
//      const storageDate = wepy.getStorageSync('collectDate')
//      const date = new Date()
//      const collectDate = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()
//      if (storageDate !== collectDate) {
//        wepy.setStorageSync('collectDate', collectDate)
//        wepy.setStorageSync('collectLength', 0)
//      }
    }

    isObject(item) {
      return typeof item === 'object' && !this.isArray(item)
    }

    isArray(item) {
      return Object.prototype.toString.apply(item) === '[object Array]'
    }

    isUndefined(item) {
      return typeof item === 'undefined'
    }

    // 向下暴露一个更换globalData的方法
    updateGlobalData(name, obj) {
      // 校验: globalData
      if (!this.globalData) return
      // 校验: 操作字段
      if (typeof name !== 'string' || name === '') return {}
      // 取已有信息
      const info = this.globalData[name] || {}
      // 更新缓存
      if (obj && this.isObject(obj)) {
        // Object合并第一层
        this.globalData[name] = Object.assign({}, info, obj)
      } else if (!this.isUndefined(obj)) {
        // 其他非undefined数据直接覆盖
        this.globalData[name] = obj
      }
      this.$apply && this.$apply()
      return this.globalData[name]
    }

    config = {
      pages: [
        'pages/find/find',  // 发现页面（不需要参数）
        'pages/index/index', // 美导页面（不需要参数）
        'pages/mine/mine',  // 我的页面（不需要参数）
        'pages/guide-center/guide-center', // 服务日志页面 （不需要参数）
        'pages/ability/ability', // 能力提升页面 （不需要参数）
        'pages/my-profile/my-profile', // 我的资料页面 （不需要参数）
        'pages/my-wellet/my-wellet', // 我的钱包页面 （不需要参数）
        'pages/my-app/my-app', // 我的小程序页面 （不需要参数）
        'pages/withdraw/withdraw',
        'pages/login/login',
        'pages/compile/compile',
        'pages/register/register',
        'pages/forget/forget',
        'pages/answer-index/answer-index', // 答题进入页面（不需要参数）
        'pages/answer/answer',
        'pages/activity-rules/activity-rules', // 活动规则（不需要参数）
        'pages/find-particulars/find-particulars', // 日志详情页面（id - 日志id）
        'pages/invitPerson/invitPerson', // 邀请美导页面（不需要参数）
        'pages/invitShop/invitShop', // 邀请门店页面（不需要参数）
        'pages/name-authentication/name-authentication', // 门店认证页面（不需要参数）
        'pages/invit-record/invit-record', // 邀请红包列表页面（id -0->已奖励红包，1->邀请成功列表，2->已经邀请还未入驻）
        'pages/invitShop-write/invitShop', // 门店被邀请注册页面（id 邀请者的id）
        'pages/invitPerson-write/invitPerson' // 美导被邀请注册页面（id 邀请者的id）
      ],
      window: {
        backgroundColor: '#F9F9F9',
        backgroundTextStyle: 'light',
        navigationBarBackgroundColor: '#fff',
        navigationBarTitleText: '共享美导',
        navigationBarTextStyle: 'black'
      },
      tabBar: {
        color: '#BEBEBE',
        selectedColor: '#706B82',
        backgroundColor: '#fff',
        borderStyle: 'black',
        list: [
          {
            pagePath: 'pages/index/index',
            text: '美导',
            iconPath: './common/image/icon-tab_find2@2x.png',
            selectedIconPath: './common/image/icon-tab_find1@2x.png'
          }, {
            pagePath: 'pages/find/find',
            text: '发现',
            iconPath: './common/image/icon-tab_find2@2x.png',
            selectedIconPath: './common/image/icon-tab_find1@2x.png'
          }, {
            pagePath: 'pages/mine/mine',
            text: '我的',
            iconPath: './common/image/icon-tab_mine2@2x.png',
            selectedIconPath: './common/image/icon-tab_mine1@2x.png'
          }
        ]
      }
    }

    globalData = {
      baseUrl: URIS.api,
      baseLogin: URIS.login
    }
  }
</script>
